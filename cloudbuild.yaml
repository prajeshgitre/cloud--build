steps:
  # Step 1: Build the Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'asia-south1-docker.pkg.dev/infra-samruddh-bharat-poc-01/my-app-01/my-app-1:latest'
      - '.'

  # Step 2: Push the Docker image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - 'asia-south1-docker.pkg.dev/infra-samruddh-bharat-poc-01/my-app-01/my-app-1:latest'

  # Step 3: Trigger Cloud Deploy
  - name: 'google/cloud-sdk:latest'
    id: Trigger Cloud Deploy
    entrypoint: 'sh'
    args:
      - -xe
      - -c
      - |
        gcloud config set deploy/region asia-south1
        gcloud deploy apply --file cloud-deploy/dev/pipeline.yaml
        gcloud deploy apply --file cloud-deploy/dev/target.yaml
        gcloud deploy releases create my-app-1-$SHORT_SHA \
                            --delivery-pipeline=my-run-demo-app-1 \
                            --skaffold-file=skaffold.yaml

  # Step 4: Describe the release
  - name: 'google/cloud-sdk:latest'
    id: Describe Cloud Deploy Release
    entrypoint: 'gcloud'
    args:
      - 'deploy'
      - 'releases'
      - 'describe'
      - 'my-app-1-$SHORT_SHA'
      - '--delivery-pipeline=my-run-demo-app-1'
      - '--region=asia-south1'

  # Step 5: Check the status of the deployed service
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Send a request to the Cloud Run service and capture the HTTP status code
        response=$(curl -o /dev/null -s -w "%{http_code}\n" https://dev-gf22ekzyxq-el.a.run.app)

        # Check the status code and take action
        if [ "$response" -eq 200 ]; then
          echo "Deployment successful! Service is healthy."
        elif [ "$response" -eq 500 ]; then
          echo "Deployment failed with status 500! Rolling back..."

          # Get the list of all releases and check their statuses
          releases=$(gcloud deploy releases list \
            --delivery-pipeline=my-run-demo-app-1 \
            --region=asia-south1 \
            --format="value(name)")

          last_successful_release=""

          for release in $releases; do
            release_status=$(gcloud deploy releases describe $release \
              --delivery-pipeline=my-run-demo-app-1 \
              --region=asia-south1 \
              --format="value(renderState)")

            if [ "$release_status" == "SUCCEEDED" ]; then
              last_successful_release=$release
              break
            fi
          done

          if [ -z "$last_successful_release" ]; then
            echo "No previous successful release found. Rollback not possible."
            exit 1
          fi

          # Re-deploy the last successful release
          gcloud deploy releases create $last_successful_release-rollback-$SHORT_SHA \
            --delivery-pipeline=my-run-demo-app-1 \
            --to-target=dev \
            --region=asia-south1 \
            --file=cloud-deploy/dev/pipeline.yaml \
            --skaffold-file=skaffold.yaml

        else
          echo "Deployment failed with status $response! Exiting."
          exit 1
        fi

images:
  - 'asia-south1-docker.pkg.dev/infra-samruddh-bharat-poc-01/my-app-01/my-app-1:latest'

logsBucket: 'gs://cloud-build-02'
