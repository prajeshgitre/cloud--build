steps:
  # Step 1: Build the Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'asia-south1-docker.pkg.dev/prj-visitor-connect-prod-goa/repo-visitor-connect-prod-as1-01/node-app:latest'
      - '.'

  # Step 2: Push the Docker image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - 'asia-south1-docker.pkg.dev/prj-visitor-connect-prod-goa/repo-visitor-connect-prod-as1-01/node-app:latest'

    # Step 3: Trigger Cloud Deploy and deploy to Cloud Run using gcloud command
  - name: 'google/cloud-sdk:latest'
    id: Trigger Cloud Deploy
    entrypoint: 'sh'
    args:
      - -xe
      - -c
      - |
        # Set region for Cloud Deploy
        gcloud config set deploy/region asia-south1

        # Apply Cloud Deploy pipeline and target configuration
        gcloud deploy apply --file cloud-deploy/dev/pipeline.yaml
        gcloud deploy apply --file cloud-deploy/dev/target.yaml

        # Deploy the Cloud Run service using the gcloud command (instead of Skaffold)
        gcloud beta run deploy crn-visitor-connect-prod-as1-node-admin \
          --image=asia-south1-docker.pkg.dev/prj-visitor-connect-prod-goa/repo-visitor-connect-prod-as1-01/node-app:latest \
          --no-allow-unauthenticated \
          --port=80 \
          --service-account=sa-cloudrun@prj-visitor-connect-prod-goa.iam.gserviceaccount.com \
          --network=vpc-visitor-connect-prod-goa-01 \
          --subnet=sb-prod-as1-cr-01 \
          --vpc-egress=private-ranges-only \
          --use-http2 \
          --session-affinity \
          --region=asia-south1 \
          --project=prj-visitor-connect-prod-goa \
          --cpu=4 \
          --memory=8Gi

        # Create a new Cloud Deploy release
        gcloud deploy releases create node-app-${SHORT_SHA}-$(date +%s) \
          --delivery-pipeline=cdep-visitor-connect-prod-as1-01 \
          --region=asia-south1
                        
  # Step to wait for 60 seconds
  - name: 'alpine:latest'
    entrypoint: 'sh'
    args:
      - '-c'
      - 'sleep 60'

  # Step 4: Check the status of the deployed service
  - name: 'google/cloud-sdk:latest'
    entrypoint: 'sh'
    args:
      - -xe
      - -c
      - |
        profile="crn-visitor-connect-prod-as1-node-admin"
        url=$(gcloud run services describe "$profile" --platform managed --region asia-south1 --format 'value(status.url)')

        response=$(curl -o /dev/null -s -w "%{http_code}\n" "$url")

        if [ "$response" -eq 200 ]; then
          echo "Deployment successful! Service is healthy."
        elif [ "$response" -eq 500 ]; then
          echo "Deployment failed with status 500! Rolling back..."

          last_release=$(gcloud deploy releases list \
            --delivery-pipeline=cdep-visitor-connect-prod-as1-01 \
            --region=asia-south1 \
            --format="yaml(name)" | awk -F'/' '{split($0,a,"/"); print a[length(a)]}')

          gcloud deploy targets rollback dev \
            --delivery-pipeline=cdep-visitor-connect-prod-as1-01 \
            --region="asia-south1" \
            --release="$last_release"
        else
          echo "Deployment failed with status $response! Exiting."
          exit 1
        fi

images:
  - 'asia-south1-docker.pkg.dev/prj-visitor-connect-prod-goa/repo-visitor-connect-prod-as1-01/node-app:latest'

logsBucket: 'gs://bkt-visitor-connect-prod-as1-cloudbuild-01'
